<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TourGuideService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">TourGuide</a> &gt; <a href="index.source.html" class="el_package">tourGuide.service</a> &gt; <span class="el_source">TourGuideService.java</span></div><h1>TourGuideService.java</h1><pre class="source lang-java linenums">package tourGuide.service;


import java.util.*;
import java.util.concurrent.*;
import java.util.stream.Collectors;
import java.util.stream.IntStream;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Service;

import tourGuide.helper.InternalTestHelper;
import tourGuide.model.*;
import tourGuide.proxy.GpsUtilProxy;
import tourGuide.proxy.RewardsCentralProxy;
import tourGuide.proxy.TripPricerProxy;
import tourGuide.tracker.Tracker;
import tourGuide.user.User;
import tourGuide.user.UserReward;


/**
 * &lt;b&gt;TourGuideService is the class that will call the different proxies of the other microservices to retrieve the data and process it&lt;/b&gt;
 * &lt;p&gt;
 *     contains methods
 *     &lt;ul&gt;
 *         &lt;li&gt;getLocation&lt;/li&gt;
 *         &lt;li&gt;trackUserLocation&lt;/li&gt;
 *         &lt;li&gt;getNearbyAttractions&lt;/li&gt;
 *         &lt;li&gt;getRewards&lt;/li&gt;
 *         &lt;li&gt;getAllCurrentLocations&lt;/li&gt;
 *         &lt;li&gt;getTripDeals&lt;/li&gt;
 *         &lt;li&gt;getAttractions&lt;/li&gt;
 *         &lt;li&gt;getUser&lt;/li&gt;
 *         &lt;li&gt;getDistance&lt;/li&gt;
 *         &lt;li&gt;getAllUsers&lt;/li&gt;
 *         &lt;li&gt;addUser&lt;/li&gt;
 *         &lt;li&gt;getApiKey&lt;/li&gt;
 *         &lt;li&gt;addShutDownHook&lt;/li&gt;
 *         &lt;li&gt;initializeInternalUsers&lt;/li&gt;
 *     &lt;/ul&gt;
 * &lt;/p&gt;
 * @author Guillaume C
 */
@Service
public class TourGuideService extends Thread{

	private GpsUtilProxy gpsUtilProxy;
	private TripPricerProxy tripPricerProxy;
	private RewardsCentralProxy rewardsCentralProxy;

<span class="fc" id="L53">	private Logger logger = LoggerFactory.getLogger(TourGuideService.class);</span>
	public Tracker tracker;
<span class="fc" id="L55">	boolean testMode = true;</span>
	private static final double STATUTE_MILES_PER_NAUTICAL_MILE = 1.15077945;



<span class="fc" id="L60">	public TourGuideService(GpsUtilProxy gpsUtilProxy, TripPricerProxy tripPricerProxy, RewardsCentralProxy rewardsCentralProxy) {</span>
<span class="fc" id="L61">		this.gpsUtilProxy = gpsUtilProxy;</span>
<span class="fc" id="L62">		this.tripPricerProxy = tripPricerProxy;</span>
<span class="fc" id="L63">		this.rewardsCentralProxy = rewardsCentralProxy;</span>


<span class="pc bpc" id="L66" title="1 of 2 branches missed.">		if(testMode) {</span>
<span class="fc" id="L67">			logger.info(&quot;TestMode enabled&quot;);</span>
<span class="fc" id="L68">			logger.debug(&quot;Initializing users&quot;);</span>
<span class="fc" id="L69">			initializeInternalUsers();</span>
<span class="fc" id="L70">			logger.debug(&quot;Finished initializing users&quot;);</span>
		}
<span class="fc" id="L72">		tracker = new Tracker(this);</span>
<span class="fc" id="L73">		addShutDownHook();</span>

<span class="fc" id="L75">	}</span>

<span class="fc" id="L77">	public TourGuideService() {</span>
<span class="fc" id="L78">	}</span>

	/**
	 * call gpsUtilProxy to get user's location from gpsUtil microservice
	 * @param user user for whom we want the last localization
	 * @return the user's location
	 */
	public Location getLocation (User user) {
<span class="nc" id="L86">		Location location = gpsUtilProxy.getLocation(user.getUserId());</span>
<span class="nc" id="L87">		return location;</span>
	}

	/**
	 * call the gpsUtilProxy to get user's current location from gpsUtil microservice
	 * @param user user for whom we want the last visitedLocation
	 * @return the last visitedLocation
	 */
	public VisitedLocation trackUserLocation(User user) {
<span class="fc" id="L96">		return gpsUtilProxy.trackUserLocation(user.getUserId());</span>
	}


	/**
	 * call the gpsProxy to get the closest 5 attractions to the user from gpsUtil microservice
	 * @param user user we use to find the 5 attractions near him
	 * @return a list of 5 attractions
	 */
	public List&lt;NearByAttractions&gt; getNearByAttractions (User user) {
<span class="nc" id="L106">		List&lt;Attraction&gt; nearAttractions = gpsUtilProxy.getNearbyAttractions(user.getUserId());</span>
<span class="nc" id="L107">		List&lt;NearByAttractions&gt; nearByAttractions = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">		for (Attraction attraction : nearAttractions) {</span>
<span class="nc" id="L109">			int rewardsPoints = rewardsCentralProxy.getAttractionRewardPoints(user.getUserId(),attraction.attractionId);</span>
<span class="nc" id="L110">			Location location = new Location(attraction.latitude,attraction.longitude);</span>
<span class="nc" id="L111">			double distance = getDistance(user.getLastVisitedLocation().location,location);</span>
<span class="nc" id="L112">			nearByAttractions.add(new NearByAttractions(attraction,distance,rewardsPoints));</span>
<span class="nc" id="L113">		}</span>
<span class="nc" id="L114">		return nearByAttractions;</span>
	}

	/**
	 * call the rewardsCentralProxy to get a list of rewards for a user from rewardCentral microservice
	 * @param user user we want to get his rewards
	 * @return a list of UserRewards
	 */
	public List&lt;UserReward&gt; getRewards (User user) throws ExecutionException, InterruptedException {
<span class="fc" id="L123">		ExecutorService executorService = Executors.newFixedThreadPool(100000);</span>
<span class="fc" id="L124">		CompletableFuture&lt;Void&gt; completableFuture = CompletableFuture</span>
<span class="fc" id="L125">				.supplyAsync(() -&gt; rewardsCentralProxy.getRewards(user), executorService)</span>
<span class="fc" id="L126">				.thenAccept( s -&gt; user.setUserRewards(s) );</span>
<span class="fc" id="L127">		completableFuture.join();</span>
<span class="fc" id="L128">		return user.getUserRewards();</span>
	}


	/**
	 * call the gpsUtilProxy to get all the users locations from gpsUtil microservice
	 * @return a list of users visitedLocations
	 */
	public List&lt;VisitedLocation&gt;getAllCurrentLocations() {
<span class="nc" id="L137">		List&lt;VisitedLocation&gt; usersCurrentVisitedLocationList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L138">		List&lt;User&gt; userList = getAllUsers();</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">		for(User user : userList){</span>
<span class="nc" id="L140">			VisitedLocation currentLocation = gpsUtilProxy.getCurrentLocation(user.getUserId());</span>
<span class="nc" id="L141">			usersCurrentVisitedLocationList.add(currentLocation);</span>
<span class="nc" id="L142">		}</span>
<span class="nc" id="L143">		return usersCurrentVisitedLocationList;</span>
	}

	/**
	 * call the tripPricerProxy to get user tripDeals from tripPricer microservice
	 * @param user is the user we use to get his tripDeals
	 * @return a list of provider with prices
	 */
	public List&lt;Provider&gt; getTripDeals(User user) {
<span class="nc" id="L152">		String apiKey  = getApiKey();</span>
<span class="nc" id="L153">		List&lt;Provider&gt; getPrice = tripPricerProxy.getPrice(user,apiKey);</span>
<span class="nc" id="L154">		return getPrice;</span>
	}

	/**
	 * call the gpsUtilProxy to get all the attractions from gpsUtil microservice
	 * @return a list of all Attractions
	 */
	public List&lt;Attraction&gt; getAttractions() {
<span class="fc" id="L162">		List&lt;Attraction&gt; attractionList = gpsUtilProxy.getAllAttractions();</span>
<span class="fc" id="L163">		return attractionList;</span>
	}

	/**
	 * this method calls the different microservices to retrieve the user
	 * @param userName username of the user
	 * @return the user
	 */
	public User getUser(String userName) {
<span class="nc" id="L172">		User user = internalUserMap.get(userName);</span>
<span class="nc" id="L173">		List&lt;VisitedLocation&gt; visitedLocations = gpsUtilProxy.getUserVisitedLocation(user.getUserId());</span>
<span class="nc" id="L174">		user.setVisitedLocations(visitedLocations);</span>
<span class="nc" id="L175">		List&lt;NearByAttractions&gt; attractions = getNearByAttractions(user);</span>
<span class="nc" id="L176">		List&lt;Attraction&gt; attractionList = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">		for (NearByAttractions attractions1 : attractions){</span>
<span class="nc" id="L178">			attractionList.add(attractions1.getAttraction());</span>
<span class="nc" id="L179">			user.setAttractions(attractionList);</span>
<span class="nc" id="L180">		}</span>

<span class="nc" id="L182">		List&lt;UserReward&gt; userRewards = rewardsCentralProxy.getRewards(user);</span>
<span class="nc" id="L183">		user.setUserRewards(userRewards);</span>
<span class="nc" id="L184">		return user;</span>
	}

	/**
	 * calculate the distance between 2 points
	 * @param loc1 is the first location
	 * @param loc2 is the second location
	 * @return a distance in nautical miles
	 */
	public double getDistance(Location loc1, Location loc2) {
<span class="nc" id="L194">		double lat1 = Math.toRadians(loc1.latitude);</span>
<span class="nc" id="L195">		double lon1 = Math.toRadians(loc1.longitude);</span>
<span class="nc" id="L196">		double lat2 = Math.toRadians(loc2.latitude);</span>
<span class="nc" id="L197">		double lon2 = Math.toRadians(loc2.longitude);</span>

<span class="nc" id="L199">		double angle = Math.acos(Math.sin(lat1) * Math.sin(lat2)</span>
<span class="nc" id="L200">				+ Math.cos(lat1) * Math.cos(lat2) * Math.cos(lon1 - lon2));</span>

<span class="nc" id="L202">		double nauticalMiles = 60 * Math.toDegrees(angle);</span>
<span class="nc" id="L203">		double statuteMiles = STATUTE_MILES_PER_NAUTICAL_MILE * nauticalMiles;</span>
<span class="nc" id="L204">		return statuteMiles;</span>
	}

	/**
	 * get all users
	 * @return a list of users
	 */
	public List&lt;User&gt; getAllUsers() {
<span class="fc" id="L212">		return internalUserMap.values().stream().collect(Collectors.toList());</span>
	}

	/**
	 * add user to list
	 * @param user the user to add
	 */
	public void addUser(User user) {
<span class="nc bnc" id="L220" title="All 2 branches missed.">		if(!internalUserMap.containsKey(user.getUserName())) {</span>
<span class="nc" id="L221">			internalUserMap.put(user.getUserName(), user);</span>
		}
<span class="nc" id="L223">	}</span>

	/**
	 * get the ApiKey
	 * @return a string of the tripPricerApiKey
	 */
	public String getApiKey() {
<span class="nc" id="L230">		return tripPricerApiKey;</span>
	}

	/**
	 * shutdown tracker
	 */
	public void addShutDownHook() {
<span class="fc" id="L237">		Runtime.getRuntime().addShutdownHook(new Thread() { </span>
		      public void run() {
<span class="fc" id="L239">		        tracker.stopTracking();</span>
<span class="fc" id="L240">		      } </span>
		    }); 
<span class="fc" id="L242">	}</span>
	
	/**********************************************************************************
	 * 
	 * Methods Below: For Internal Testing
	 * 
	 **********************************************************************************/
<span class="fc" id="L249">	private final String tripPricerApiKey = &quot;test-server-api-key&quot;;</span>
	// Database connection will be used for external users, but for testing purposes internal users are provided and stored in memory
<span class="fc" id="L251">	private final Map&lt;String, User&gt; internalUserMap = new HashMap&lt;&gt;();</span>
	private void initializeInternalUsers() {
<span class="fc" id="L253">		IntStream.range(0, InternalTestHelper.getInternalUserNumber()).forEach(i -&gt; {</span>
<span class="fc" id="L254">			String userName = &quot;internalUser&quot; + i;</span>
<span class="fc" id="L255">			String phone = &quot;000&quot;;</span>
<span class="fc" id="L256">			String email = userName + &quot;@tourGuide.com&quot;;</span>
<span class="fc" id="L257">			User user = new User(UUID.randomUUID(), userName, phone, email);</span>
			
<span class="fc" id="L259">			internalUserMap.put(userName, user);</span>
<span class="fc" id="L260">		});</span>
<span class="fc" id="L261">		logger.debug(&quot;Created &quot; + InternalTestHelper.getInternalUserNumber() + &quot; internal test users.&quot;);</span>
<span class="fc" id="L262">	}</span>

	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>